<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.147.8">
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title> :: AWS System Manager</title>

    
    <link href="/css/nucleus.css?1754031498" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1754031498" rel="stylesheet">
    <link href="/css/hybrid.css?1754031498" rel="stylesheet">
    <link href="/css/featherlight.min.css?1754031498" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1754031498" rel="stylesheet">
    <link href="/css/auto-complete.css?1754031498" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1754031498" rel="stylesheet">
    <link href="/css/theme.css?1754031498" rel="stylesheet">
    <link href="/css/hugo-theme.css?1754031498" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1754031498" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1754031498"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/test/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1754031498"></script>
<script type="text/javascript" src="/js/auto-complete.js?1754031498"></script>
<script type="text/javascript">
    
        var baseurl = "\/\/localhost:1313\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1754031498"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/1-introduce/" title="Introduce" class="dd-item 
        
        
        
        ">
      <a href="/1-introduce/">
           <b> 1. </b> Introduce
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/2-prerequiste/" title="Preparation " class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/">
           <b> 2. </b> Preparation 
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/" title="Preparing VPC and EC2" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/">
           <b> 2.1 </b> Preparing VPC and EC2
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/2.1.1-createvpc/" title="Create VPC" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/2.1.1-createvpc/">
           <b> 2.1.1 </b> Create VPC
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/2.1.2-createpublicsubnet/" title="Create Public Subnet" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/2.1.2-createpublicsubnet/">
           <b> 2.1.2 </b> Create Public Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/2.1.3-createprivatesubnet/" title="Create Private Subnet" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/2.1.3-createprivatesubnet/">
           <b> 2.1.3 </b> Create Private Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/2.1.4-createsecgroup/" title="Create security groups" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/2.1.4-createsecgroup/">
           <b> 2.1.4 </b> Create security groups
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/2.1.5-createec2linux/" title="Create Public instance" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/2.1.5-createec2linux/">
           <b> 2.1.5 </b> Create Public instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.1-createec2/2.1.6-createec2windows/" title="Create Private Instance" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.1-createec2/2.1.6-createec2windows/">
           <b> 2.1.6 </b> Create Private Instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/2-prerequiste/2.2-createiamrole/" title="Create IAM Role" class="dd-item 
        
        
        
        ">
      <a href="/2-prerequiste/2.2-createiamrole/">
           <b> 2.2 </b> Create IAM Role
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/" title="Connect to EC2 servers" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/">
           <b> 3. </b> Connect to EC2 servers
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.1-public-instance/" title="Connect to Public Instance" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.1-public-instance/">
           <b> 3.1. </b> Connect to Public Instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/" title="Connect to Private instance" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/">
           <b> 3.2. </b> Connect to Private instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/3.2.1-enablevpcdns/" title="Enable DNS hostnames" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/3.2.1-enablevpcdns/">
           <b> 3.2.1 </b> Enable DNS hostnames
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/" title="Create VPC Endpoint" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/">
           <b> 3.2.2 </b> Create VPC Endpoint
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/3.2.2.1-endpointssm/" title="Create Endpoint ssm" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/3.2.2.1-endpointssm/">
           <b> 3.2.2.1 </b> Create Endpoint ssm
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/3.2.2.2-endpointssmmessages/" title="Create Endpoint ssmmessages" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/3.2.2.2-endpointssmmessages/">
           <b> 3.2.2.2 </b> Create Endpoint ssmmessages
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/3.2.2.3-endpointec2messages/" title="Create Endpoint ec2messages" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/3.2.2-createvpcendpoint/3.2.2.3-endpointec2messages/">
           <b> 3.2.2.3 </b> Create Endpoint ec2messages
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/3-accessibilitytoinstances/3.2-private-instance/3.2.3-connectec2/" title="Connect to instance" class="dd-item 
        
        
        
        ">
      <a href="/3-accessibilitytoinstances/3.2-private-instance/3.2.3-connectec2/">
           <b> 3.2.3 </b> Connect to instance
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/4-s3log/" title="Manage session logs" class="dd-item 
        
        
        
        ">
      <a href="/4-s3log/">
           <b> 4. </b> Manage session logs
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/4-s3log/4.1-updateiamrole/" title="Update IAM Role" class="dd-item 
        
        
        
        ">
      <a href="/4-s3log/4.1-updateiamrole/">
           <b> 4.1 </b> Update IAM Role
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4-s3log/4.2-creates3bucket/" title="Create S3 Bucket" class="dd-item 
        
        
        
        ">
      <a href="/4-s3log/4.2-creates3bucket/">
           <b> 4.2 </b> Create S3 Bucket
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4-s3log/4.3-creategwes3/" title="Create S3 Gateway endpoint" class="dd-item 
        
        
        
        ">
      <a href="/4-s3log/4.3-creategwes3/">
           <b> 4.3 </b> Create S3 Gateway endpoint
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/4-s3log/4.4-configsessionlogs/" title="Monitor session logs" class="dd-item 
        
        
        
        ">
      <a href="/4-s3log/4.4-configsessionlogs/">
           <b> 4.4 </b> Monitor session logs
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/5-portfwd/" title="Port Forwarding" class="dd-item 
        
        
        
        ">
      <a href="/5-portfwd/">
           <b> 5. </b> Port Forwarding
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/6-cleanup/" title="Clean up resources" class="dd-item 
        
        
        
        ">
      <a href="/6-cleanup/">
          <b>6. </b>Clean up resources
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/awsstudygroupfcj/"><i class='fab fa-facebook'></i> AWS Study Group</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="//localhost:1313/test/" selected>English</option>
                    
                  
              
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
     <b> Workshop</b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7920860&style=0038&nbdigits=9&type=page&initCount=0" title="Migrate" Alt="web counter"   border="0" /></a>  <br>
     <b> <a href="https://cloudjourney.awsstudygroup.com/">Cloud Journey</a></b> <br>
    <img src="https://hitwebcounter.com/counter/counter.php?page=7830807&style=0038&nbdigits=9&type=page&initCount=0" title="Total CLoud Journey" Alt="web counter"   border="0"   />
     
</left>
<left>
    <br>
    <br>
        <b> Last Updated </b> <br>
        <i><font color=orange>30-01-2022</font></i>
    </left>
    <left>
        <br>
        <br>
            <b> Team </b> <br>
           
            <i> <a href="https://www.linkedin.com/in/sutrinh/"  style="color:orange">Sá»­ Trá»‹nh  </a> <br>
                <a href="https://www.linkedin.com/in/jotaguy"  style="color:orange">Gia HÆ°ng </a> <br>
                <a href="https://www.linkedin.com/in/hiepnguyendt"  style="color:orange">Thanh Hiá»‡p </a>
               
        </i>
        </left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            <a href='/'>Session Management</a> > 
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#table-of-contents">Table of Contents</a></li>
    <li><a href="#project-overview">Project Overview</a></li>
    <li><a href="#setup-instructions">Setup Instructions</a>
      <ul>
        <li><a href="#1-create-an-iam-role">1. Create an IAM Role</a></li>
        <li><a href="#2-enable-guardduty">2. Enable GuardDuty</a></li>
        <li><a href="#3-launch-two-ec2-instances">3. Launch Two EC2 Instances</a></li>
        <li><a href="#4-create-a-restricted-security-group">4. Create a Restricted Security Group</a></li>
        <li><a href="#5-add-threat-list-file-to-s3-and-configure-guardduty-threat-list">5. Add Threat List File to S3 and Configure GuardDuty Threat List</a></li>
        <li><a href="#6-set-up-the-lambda-function">6. Set Up the Lambda Function</a></li>
        <li><a href="#7-configure-eventbridge-rule">7. Configure EventBridge Rule</a></li>
        <li><a href="#8-create-sns-topic-for-notifications">8. Create SNS Topic for Notifications</a></li>
      </ul>
    </li>
    <li><a href="#testing-the-workflow">Testing the Workflow</a></li>
    <li><a href="#cleanup">Cleanup</a></li>
    <li><a href="#real-world-considerations">Real-World Considerations</a></li>
    <li><a href="#references">References</a></li>
    <li><a href="#license"><strong>License</strong></a></li>
    <li><a href="#contributing"><strong>Contributing</strong></a></li>
    <li><a href="#author"><strong>Author</strong></a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        

        </div>
        
        <div id="body-inner">
          
            <h1>
              
              
            </h1>
          

        


<h1 id="automating-ec2-instance-isolation-with-aws-lambda-and-guardduty">Automating EC2 Instance Isolation with AWS Lambda and GuardDuty</h1>
<p><img src="https://github.com/reyincyber/aws/blob/a62ca55ed1a79838400d853ac95882f37a783510/automating-incident-response/architectural%20diagrams/automating_idr_bc.drawio.png" alt="image alt"></p>
<p>This repository provides a detailed guide for setting up an automated workflow to isolate compromised EC2 instances in response to AWS GuardDuty findings. The workflow uses EC2, GuardDuty, S3, EventBridge, and Lambda to detect, mitigate, and notify about security threats while adhering to the <strong>principle of least privilege</strong> for IAM roles and policies.</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="/test/#project-overview">Project Overview</a>
<ul>
<li><a href="/test/#%f0%9f%94%97-Code-and-documentation:">ðŸ”— Code and Documentation:</a></li>
</ul>
</li>
<li><a href="/test/#setup-instructions">Setup Instructions</a>
<ul>
<li><a href="/test/#1-create-an-iam-role">Create IAM Role</a></li>
<li><a href="/test/#2-enable-guardduty">Enable GuardDuty</a></li>
<li><a href="/test/#3-launch-two-ec2-instances">Launch EC2 Instances</a></li>
<li><a href="/test/#4-create-a-restricted-security-group">Create Restricted Security Group</a></li>
<li><a href="/test/#5-add-threat-list-file-to-s3-and-configure-guardduty-threat-list">Add Threat List to S3</a></li>
<li><a href="/test/#6-set-up-the-lambda-function">Set Up Lambda Function</a></li>
<li><a href="/test/#7-configure-eventbridge-rule">Configure EventBridge Rule</a></li>
<li><a href="/test/#8-create-sns-topic-for-notifications">Create SNS Topic for Notifications</a></li>
</ul>
</li>
<li><a href="/test/#testing-the-workflow">Testing the Workflow</a></li>
<li><a href="/test/#cleanup">Cleanup</a></li>
<li><a href="/test/#real-world-considerations">Real-World Considerations</a></li>
<li><a href="/test/#references">References</a></li>
</ol>
<hr>
<h2 id="project-overview">Project Overview</h2>
<p>This project automates the process of detecting and isolating compromised EC2 instances in real-time, minimizing security risks. It is designed for AWS users of all levels, including beginners, and includes step-by-step instructions to deploy the required resources and configurations. Features:</p>
<ul>
<li><strong>Real-time Threat Detection:</strong> Utilize Amazon GuardDuty to monitor malicious activities.</li>
<li><strong>Automated Instance Isolation:</strong> Use AWS Lambda to stop and isolate compromised instances.</li>
<li><strong>Customizable Workflow:</strong> Integrate a custom threat list using S3.</li>
<li><strong>Notifications:</strong> Receive real-time email alerts via SNS.</li>
</ul>
<p>ðŸ”— Code and Documentation:
<a href="https://github.com/reyincyber/aws-security/tree/861c663e487afa7e966cab4069c6db1d76fa8ace/automating-incident-response">GitHub Repository</a>; <a href="https://cyberrey.medium.com/automating-ec2-instance-isolation-with-aws-lambda-and-guardduty-33a34fc88177">Medium Walkthrough</a>; <a href="https://youtu.be/RCmdjOjsGUw">Youtube</a></p>
<hr>
<h2 id="setup-instructions">Setup Instructions</h2>
<h3 id="1-create-an-iam-role">1. Create an IAM Role</h3>
<p><strong>Purpose:</strong> Enable Lambda to manage security groups, stop instances, and interact with GuardDuty.</p>
<ol>
<li>Navigate to the <strong>IAM Console</strong> â†’ <strong>Roles</strong> â†’ <strong>Create Role</strong>.</li>
<li>Select <strong>AWS Service</strong> â†’ <strong>Lambda</strong> under trusted entities.</li>
<li>Attach the following policies:
<ul>
<li><code>AmazonEC2FullAccess</code></li>
<li><code>AWSLambdaFullAccess</code></li>
</ul>
</li>
<li>Name the role (e.g., <code>LambdaSecurityRole</code>) and create it.
<img src="https://github.com/user-attachments/assets/f0262258-e5fd-4c22-ae50-759ebba9ce72" alt="Image"></li>
</ol>
<hr>
<h3 id="2-enable-guardduty">2. Enable GuardDuty</h3>
<p><strong>Purpose:</strong> Monitor for malicious activities in your AWS environment.</p>
<ol>
<li>Open the <strong>GuardDuty Console</strong>.</li>
<li>Click <strong>Enable GuardDuty</strong> if not already enabled.</li>
</ol>
<hr>
<h3 id="3-launch-two-ec2-instances">3. Launch Two EC2 Instances</h3>
<p><strong>Purpose:</strong> Simulate a malicious actor (<code>MaliciousEC2</code>) and a compromised instance (<code>CompromisedEC2</code>).</p>
<ol>
<li>In the <strong>EC2 Console</strong>, click <strong>Launch Instance</strong>.</li>
<li>Configure the instances:
<ul>
<li><strong>AMI:</strong> Amazon Linux 2</li>
<li><strong>Type:</strong> <code>t2.micro</code></li>
<li><strong>User Data Script:</strong>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>yum update -y
</span></span><span style="display:flex;"><span>yum install nmap -y
</span></span></code></pre></div></li>
</ul>
</li>
<li>Name the instances <code>MaliciousEC2</code> and <code>CompromisedEC2</code>.
<img src="https://github.com/user-attachments/assets/81e60d50-40b4-4c9b-8bfe-da032340ef94" alt="Image"></li>
</ol>
<hr>
<h3 id="4-create-a-restricted-security-group">4. Create a Restricted Security Group</h3>
<p><strong>Purpose:</strong> Restrict traffic to isolate compromised instances.</p>
<ol>
<li>In <strong>Security Groups</strong>, create a new group:
<ul>
<li><strong>Name:</strong> <code>IsolatedSecurityGroup</code></li>
<li><strong>Inbound Rules:</strong> SSH (Port 22) from your IP.</li>
<li><strong>Outbound Rules:</strong> Default.
<img src="https://github.com/user-attachments/assets/9bf4ca6a-e72a-43c4-a55b-6e341b56376e" alt="Image"></li>
</ul>
</li>
</ol>
<hr>
<h3 id="5-add-threat-list-file-to-s3-and-configure-guardduty-threat-list">5. Add Threat List File to S3 and Configure GuardDuty Threat List</h3>
<p><strong>Purpose:</strong> Simulate threats using an S3-hosted IP list.</p>
<ol>
<li>Create an <strong>S3 Bucket</strong> (e.g., <code>threat-list-bucket</code>).</li>
<li>Upload a <code>threatlist.txt</code> file containing <code>MaliciousEC2</code>&rsquo;s IP.</li>
<li>Configure GuardDuty to use the S3 threat list:
<ul>
<li>Navigate to <strong>GuardDuty</strong> â†’ <strong>Settings</strong> â†’ <strong>Threat Lists</strong>.</li>
<li>Add the S3 URL of your threat list file.
<img src="https://github.com/user-attachments/assets/fa2fe142-a4d5-44d5-99e6-5189a57528ce" alt="Image"></li>
</ul>
</li>
</ol>
<hr>
<h3 id="6-set-up-the-lambda-function">6. Set Up the Lambda Function</h3>
<p><strong>Purpose:</strong> Automate the response to GuardDuty findings.</p>
<ol>
<li>Create a Lambda function (<code>IsolateInstance</code>) with Python 3.8+ as the runtime.</li>
<li>Add the <a href="https://github.com/reyincyber/aws/blob/e2619c4c47ea91bdf671186a4abbc0d18a86380f/automating-incident-response/lambda.py">Python code</a>.</li>
<li>Assign the <code>LambdaSecurityRole</code> to the function.</li>
<li>Deploy and test the function.
<img src="https://github.com/user-attachments/assets/0c614d4f-93f3-42c5-b24a-2a9828088d68" alt="Image"></li>
</ol>
<hr>
<h3 id="7-configure-eventbridge-rule">7. Configure EventBridge Rule</h3>
<p><strong>Purpose:</strong> Trigger Lambda on GuardDuty findings.</p>
<ol>
<li>Create a new rule in <strong>EventBridge</strong>:
<ul>
<li><strong>Name:</strong> <code>GuardDutyToLambdaRule</code></li>
<li><strong>Event Source:</strong> GuardDuty</li>
<li>Use the <a href="https://github.com/reyincyber/aws/blob/65bc7573964be2e71d8c3fbaa0159592a62f65be/automating-incident-response/event_pattern.json">event pattern JSON</a>.</li>
<li><strong>Target:</strong> Lambda function (<code>IsolateInstance</code>).
<img src="https://github.com/user-attachments/assets/8e5f8328-d0be-475b-9afe-e9f815caf98c" alt="Image">
<img src="https://github.com/user-attachments/assets/8b6d12d1-2cb6-4fa8-ac4b-575dfc90be52" alt="Image"></li>
</ul>
</li>
</ol>
<hr>
<h3 id="8-create-sns-topic-for-notifications">8. Create SNS Topic for Notifications</h3>
<p><strong>Purpose:</strong> Notify users of security events.</p>
<ol>
<li>Create an SNS Topic (<code>GuardDutyNotifications</code>).</li>
<li>Subscribe your email to the topic and confirm via email.
<img src="https://github.com/user-attachments/assets/ff0ff868-00c4-43af-89ba-ddca9d5f0d20" alt="Image">
<img src="https://github.com/user-attachments/assets/ca35ded7-ab1a-4d8c-803e-089055766b01" alt="Image"></li>
</ol>
<hr>
<h2 id="testing-the-workflow">Testing the Workflow</h2>
<p><img src="https://github.com/reyincyber/aws/blob/main/automating-incident-response/architectural%20diagrams/automating_idr_ac.drawio.png" alt="image alt"></p>
<ol>
<li>Connect to <code>CompromisedEC2</code> via SSH.</li>
<li>Execute a payload script to simulate malicious activity. Script reference: <a href="https://github.com/reyincyber/aws/blob/95e71ee372768d4f1e1f3c556d28d03c79a9220a/automating-incident-response/test.sh">test.sh</a>.</li>
<li>Verify:
<ul>
<li>GuardDuty findings.</li>
<li>Isolation and stopping of <code>CompromisedEC2</code>.</li>
<li>SNS notifications.
<img src="https://github.com/user-attachments/assets/30c38b40-8e1a-4148-a8ce-79cf617d977d" alt="Image">
<img src="https://github.com/user-attachments/assets/7f18f920-a3a5-4abc-891e-9e3872369627" alt="Image">
<img src="https://github.com/user-attachments/assets/acaf0fe1-13ea-448c-ba16-dcd73fae752a" alt="Image">
<img src="https://github.com/user-attachments/assets/a3bd6558-5c49-498d-8d1c-117f14c0dca7" alt="Image">
<img src="https://github.com/user-attachments/assets/309bd32f-7d63-402e-89c7-5dba09011603" alt="Image"></li>
</ul>
</li>
</ol>
<hr>
<h2 id="cleanup">Cleanup</h2>
<p><img src="https://github.com/user-attachments/assets/4bb61057-7b3b-47d6-b6c6-30dfbbe5a257" alt="Image"></p>
<ol>
<li>Delete all resources:
<ul>
<li>EC2 instances</li>
<li>Lambda functions</li>
<li>S3 bucket</li>
<li>IAM roles</li>
<li>EventBridge rules</li>
<li>SNS topics</li>
</ul>
</li>
<li>Verify that no resources are left to avoid unnecessary costs.</li>
</ol>
<hr>
<h2 id="real-world-considerations">Real-World Considerations</h2>
<ol>
<li><strong>Instance Availability:</strong> Use severity-based isolation strategies to avoid unnecessary disruptions.</li>
<li><strong>Minimizing False Positives:</strong> Fine-tune GuardDuty and use suppression rules.</li>
<li><strong>Enhanced Security Practices:</strong> Implement comprehensive logging and multi-layer security.</li>
</ol>
<hr>
<h2 id="references">References</h2>
<ol>
<li><a href="https://www.youtube.com/watch?v=ZRpLrPjvNkk">Cloud4DevOps</a></li>
<li><a href="https://aws.amazon.com/blogs/security/how-to-automate-incident-response-to-security-events-with-aws-systems-manager-incident-manager/">AWS Incident Response Blog</a></li>
<li><a href="https://perd1x.medium.com/automatically-isolate-compromised-ec2-instances-with-guardduty-d4080e8b039a">Automatically Isolate EC2 Instances</a></li>
</ol>
<h2 id="license"><strong>License</strong></h2>
<p>This project is licensed under the MIT License. See the <a href="LICENSE">LICENSE</a> file for details.</p>
<hr>
<h2 id="contributing"><strong>Contributing</strong></h2>
<p>Contributions are welcome! Feel free to open an issue or submit a pull request for improvements or fixes.</p>
<hr>
<h2 id="author"><strong>Author</strong></h2>
<p>Created by <a href="https://github.com/reyincyber">reyincyber</a>. Follow for more cloud security projects!</p>


<footer class="footline">
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
        
        


	 
	 
		
		
			<a class="nav nav-next" href="/1-introduce/" title="Introduce" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1754031498"></script>
    <script src="/js/perfect-scrollbar.min.js?1754031498"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1754031498"></script>
    <script src="/js/jquery.sticky.js?1754031498"></script>
    <script src="/js/featherlight.min.js?1754031498"></script>
    <script src="/js/highlight.pack.js?1754031498"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1754031498"></script>
    <script src="/js/learn.js?1754031498"></script>
    <script src="/js/hugo-learn.js?1754031498"></script>

    <link href="/mermaid/mermaid.css?1754031498" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1754031498"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>

